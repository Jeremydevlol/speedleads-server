# üì∏ Instagram DM Integration - Quick Start

## ‚ö° Instalaci√≥n R√°pida

```bash
# 1. Ejecutar script de setup
chmod +x scripts/setup-instagram.sh
./scripts/setup-instagram.sh

# 2. Instalar dependencias manualmente (alternativa)
npm install instagram-private-api bottleneck bullmq ioredis
```

## üîß Configuraci√≥n M√≠nima

### 1. Variables de Entorno (.env)

```env
# Instagram
IG_USERNAME=tu_cuenta_secundaria
IG_PASSWORD=tu_password

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=uniclick2025
```

### 2. Iniciar Redis

**Opci√≥n A: Docker**
```bash
docker-compose -f docker-compose.instagram.yml up -d redis
```

**Opci√≥n B: Local**
```bash
redis-server
```

### 3. Migraciones de BD

```bash
psql -U your_user -d uniclick -f db/migrations/2025-01-21_create_instagram_tables.sql
```

## üöÄ Uso B√°sico

### Desde el Backend (API REST)

```javascript
// 1. Login
POST /api/instagram/login
{
  "username": "tu_usuario",
  "password": "tu_password"
}

// 2. Enviar DM
POST /api/instagram/send
{
  "username": "destinatario",
  "text": "Hola!"
}

// 3. Responder con IA
POST /api/instagram/reply-ai
{
  "thread_id": "123456789",
  "text": "Mensaje del usuario",
  "personality_id": 1
}

// 4. Sincronizar inbox
GET /api/instagram/sync-inbox
```

### Desde el Frontend (Socket.IO)

```javascript
import { io } from 'socket.io-client';

const socket = io('http://localhost:5001');

// Login
socket.emit('instagram:send', {
  token: jwtToken,
  username: 'destinatario',
  text: 'Hola desde Socket.IO!'
});

// Escuchar mensajes
socket.on('instagram:message', (data) => {
  console.log('Nuevo mensaje:', data);
});

// Escuchar estado
socket.on('instagram:status', (data) => {
  console.log('Estado:', data.connected);
});
```

## üìÅ Estructura de Archivos

```
api/
‚îú‚îÄ‚îÄ dist/
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ instagramService.js      # Servicio principal
‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ instagramController.js   # Controlador de endpoints
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ instagramRoutes.js       # Rutas API
‚îÇ   ‚îî‚îÄ‚îÄ workers/
‚îÇ       ‚îî‚îÄ‚îÄ instagramQueue.js        # Worker de cola (BullMQ)
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îî‚îÄ‚îÄ migrations/
‚îÇ       ‚îî‚îÄ‚îÄ 2025-01-21_create_instagram_tables.sql
‚îú‚îÄ‚îÄ storage/
‚îÇ   ‚îî‚îÄ‚îÄ ig_state/                    # Sesiones guardadas
‚îú‚îÄ‚îÄ docker-compose.instagram.yml     # Docker con Redis
‚îú‚îÄ‚îÄ .env.instagram.example           # Variables de entorno
‚îú‚îÄ‚îÄ INSTAGRAM_INTEGRATION_GUIDE.md   # Documentaci√≥n completa
‚îî‚îÄ‚îÄ INSTAGRAM_README.md              # Este archivo
```

## ‚ö†Ô∏è Advertencias Importantes

### üö® RIESGOS
- **Alto riesgo de baneo** si usas tu cuenta principal
- Instagram detecta automatizaci√≥n f√°cilmente
- **Usa SOLO cuentas secundarias** para testing

### üìä L√çMITES RECOMENDADOS
- M√°ximo **30-50 DMs por d√≠a** al inicio
- Esperar **1.5-2 segundos** entre mensajes
- Evitar actividad nocturna
- Usar proxies residenciales en producci√≥n

### üõ°Ô∏è PROTECCIONES IMPLEMENTADAS
- ‚úÖ Rate limiting con Bottleneck (1.5s entre acciones)
- ‚úÖ Cola de mensajes con BullMQ
- ‚úÖ Reintentos autom√°ticos con backoff exponencial
- ‚úÖ Detecci√≥n de challenges y rate limits
- ‚úÖ Persistencia de sesi√≥n (no reloguear constantemente)

## üß™ Testing

### Test Manual

```bash
# 1. Login
curl -X POST http://localhost:5001/api/instagram/login \
  -H "Authorization: Bearer YOUR_JWT" \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test123"}'

# 2. Verificar estado
curl -X GET http://localhost:5001/api/instagram/status \
  -H "Authorization: Bearer YOUR_JWT"

# 3. Enviar DM
curl -X POST http://localhost:5001/api/instagram/send \
  -H "Authorization: Bearer YOUR_JWT" \
  -H "Content-Type: application/json" \
  -d '{"username":"destinatario","text":"Test"}'
```

### Test con Postman

Importa esta colecci√≥n:

```json
{
  "info": {
    "name": "Instagram API",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Login",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\"username\":\"test\",\"password\":\"test123\"}"
        },
        "url": "{{base_url}}/api/instagram/login"
      }
    }
  ]
}
```

## üîÑ Integraci√≥n con app.js

Agrega esto a tu `dist/app.js`:

```javascript
// Importar rutas y servicios de Instagram
import instagramRoutes from './routes/instagramRoutes.js';
import { configureIGIO, getOrCreateIGSession } from './services/instagramService.js';

// Registrar rutas
app.use('/api/instagram', instagramRoutes);

// Configurar Socket.IO
configureIGIO(io);

// Handlers de Socket.IO
io.on('connection', (socket) => {
  socket.on('instagram:send', async ({ token, username, text }) => {
    try {
      const payload = jwt.verify(token, JWT_SECRET);
      const userId = payload.userId || payload.sub;
      
      const igService = await getOrCreateIGSession(userId);
      await igService.sendText({ username, text });
      
      socket.emit('instagram:message-sent', { success: true });
    } catch (error) {
      socket.emit('instagram:error', { message: error.message });
    }
  });
});
```

## üìä Monitoreo

### Ver logs
```bash
tail -f logs/instagram.log
```

### Monitorear Redis
```bash
redis-cli monitor
```

### Ver cola (Redis Commander)
```bash
docker-compose -f docker-compose.instagram.yml --profile debug up redis-commander
# Acceder a: http://localhost:8081
```

### Estad√≠sticas de cola
```javascript
import { getQueueStats } from './workers/instagramQueue.js';

const stats = await getQueueStats();
console.log(stats);
// { waiting: 5, active: 1, completed: 100, failed: 2 }
```

## üêõ Troubleshooting

| Error | Soluci√≥n |
|-------|----------|
| "Challenge requerido" | Resuelve el challenge en la app oficial de Instagram |
| "Rate limit alcanzado" | Espera 24 horas y reduce volumen de mensajes |
| "Sesi√≥n no activa" | Haz login nuevamente con `/api/instagram/login` |
| "Connection to Redis failed" | Verifica que Redis est√© corriendo: `redis-cli ping` |
| "instagram-private-api not found" | Ejecuta: `npm install instagram-private-api` |

## üìö Documentaci√≥n Completa

Para m√°s detalles, consulta:
- **[INSTAGRAM_INTEGRATION_GUIDE.md](./INSTAGRAM_INTEGRATION_GUIDE.md)** - Gu√≠a completa
- **[instagram-private-api Docs](https://github.com/dilame/instagram-private-api)** - Documentaci√≥n de la librer√≠a
- **[BullMQ Docs](https://docs.bullmq.io/)** - Documentaci√≥n de la cola

## üîê Seguridad

### Mejores Pr√°cticas
- ‚úÖ Nunca commitear credenciales en `.env`
- ‚úÖ Usar variables de entorno en producci√≥n
- ‚úÖ Rotar contrase√±as regularmente
- ‚úÖ Usar proxies para m√∫ltiples cuentas
- ‚úÖ Monitorear logs de errores

### Encriptar Credenciales (Producci√≥n)
```javascript
// Usar bcrypt para encriptar passwords en BD
import bcrypt from 'bcrypt';

const hashedPassword = await bcrypt.hash(password, 10);
// Guardar hashedPassword en BD
```

## üöÄ Despliegue

### Docker
```bash
# Build
docker build -t uniclick-api .

# Run con Redis
docker-compose -f docker-compose.instagram.yml up -d
```

### PM2 (Producci√≥n)
```bash
# Instalar PM2
npm install -g pm2

# Iniciar app
pm2 start dist/app.js --name uniclick-api

# Iniciar worker
pm2 start dist/workers/instagramQueue.js --name instagram-worker

# Ver logs
pm2 logs
```

## üìû Soporte

Para problemas o preguntas:
1. Revisar [INSTAGRAM_INTEGRATION_GUIDE.md](./INSTAGRAM_INTEGRATION_GUIDE.md)
2. Verificar logs: `tail -f logs/instagram.log`
3. Revisar Redis: `redis-cli monitor`
4. Contactar al equipo de desarrollo

---

**‚ö†Ô∏è RECORDATORIO:** Usa SOLO cuentas secundarias. Instagram puede banear sin previo aviso.

**‚úÖ LISTO PARA USAR:** Sigue los pasos de instalaci√≥n y estar√°s enviando DMs con IA en minutos.
